{"version":3,"sources":["Chrome.js"],"names":[],"mappings":"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","file":"../Chrome.js","sourcesContent":["export class Chrome {\n\n    constructor(name = 'unassigned') {\n        this.name = name;\n        this.fs = require('fs');\n        this.path = require('path');\n        this.Jimp = require('jimp');\n        this.utils = require('./utils');\n        this.interface = require('chrome-remote-interface');\n        this.launcher = require('lighthouse/chrome-launcher/chrome-launcher');\n\n        this.screenshotsDir = `screenshots-${name}`;\n\n        let EventEmitter = require('events');\n        this.EE = new EventEmitter();\n\n        this.init();\n    }\n\n    async init() {\n        try {\n            this.chrome = await this.launch();\n            this.protocol = await this.genProtocol();\n            await this.enable_page_and_runtime();\n            await this.enable_emulation();\n            this.EE.emit('initialised');\n        } catch(e) {\n            console.error(e);\n        }\n    }\n\n    async launch(headless = true) {\n        return this.launcher.launch({\n            chromeFlags: [\n                '--window-size=1366, 768',\n                '--disable-gpu',\n                headless ? '--headless' : ''\n            ]\n        });\n    }\n\n    async genProtocol() {\n        return this.interface({ port: this.chrome.port });\n    }\n\n    async enable_page_and_runtime() {\n        const { Page, Runtime } = this.protocol;\n        this.Page = Page;\n        this.Runtime = Runtime;\n\n        await this.Page.enable();\n        await this.Runtime.enable();\n    }\n\n    async enable_emulation() {\n        const { Emulation } = this.protocol;\n        this.Emulation = Emulation;\n    }\n\n    async kill() {\n        await this.protocol.close();\n        await this.chrome.kill();\n    }\n\n    async capture_page() {\n        try {\n\n            await this.utils.rmdir(`./${this.screenshotsDir}`);\n            await this.utils.mkdir(this.path.resolve(`./${this.screenshotsDir}`));\n\n            await this.clear_cookie_banner();\n\n            const RESULT = await this.Runtime.evaluate({ expression: 'document.body.scrollHeight' });\n            const DOC_LENGTH = RESULT.result.value;\n            const ITER_COUNT = Math.floor(DOC_LENGTH / 768);\n            const REMAINS = Math.floor(768 * (ITER_COUNT - Math.floor(ITER_COUNT)));\n\n            if (ITER_COUNT === 1) {\n                let {data} = await this.Page.captureScreenshot();\n                this.fs.writeFileSync(`${this.screenshotsDir}/result.png`, Buffer.from(data, 'base64'));\n            } else {\n                for (let i = 1; i < ITER_COUNT; i++) {\n                    let {data} = await this.Page.captureScreenshot();\n                    this.fs.writeFileSync(`${this.screenshotsDir}/current${i}.png`, Buffer.from(data, 'base64'));\n                    await this.Runtime.evaluate({ expression: 'window.scroll(0, 768)' });\n                }\n\n                await this.Emulation.setVisibleSize({ width: 1366, height: REMAINS });\n                await this.Emulation.forceViewport({ x: 0, y: (DOC_LENGTH - REMAINS), scale: 1 });\n\n                let {data} = await this.Page.captureScreenshot();\n                this.fs.writeFileSync(`${this.screenshotsDir}/current${i}.png`, Buffer.from(data, 'base64'));\n\n                this.stitch_page(ITER_COUNT);\n            }\n\n        } catch (err) {\n\n            console.error(err);\n\n        } finally {\n\n            await this.kill();\n            \n        }\n    }\n\n    async clear_cookie_banner() {\n        await this.Runtime.evaluate({ expression: `\n            let el = document.getElementById(\"cookieBanner\");\n            el.parentNode.removeChild(el);\n        ` })\n    }\n\n    async stitch_page(count, imagePath = `./${this.screenshotsDir}/current1.png`) {\n        if (count > 10) {\n            // WILL MERGE SORT BLIT\n            // for () {\n            //     let img = stitcher(count, imagePath = `./${this.screenshotsDir}/current1.png`)\n            // }\n        } else {\n            let img = stitcher(count, imagePath = `./${this.screenshotsDir}/current1.png`)\n            img.write(`./${this.screenshotsDir}/result.png`);\n        }\n    }\n\n    async stitcher() {\n        let img = await this.Jimp.read(imagePath);\n        for (let i = 1; i < count; i++) {\n            let next_img;\n            this.Jimp.read(`./${this.screenshotsDir}/current${i + 1}.png`, (e, img) => {\n                if (e) throw e;\n                img.quality(50)\n                next_img = img;\n            });\n\n            img\n                .contain(\n                    img.bitmap.width,\n                    (img.bitmap.height + next_img.bitmap.height),\n                    this.Jimp.VERTICAL_ALIGN_TOP\n                )\n                .blit(\n                    next_img,\n                    0,\n                    (img.bitmap.height - next_img.bitmap.height)\n                );\n        }\n\n        return img;\n    }\n\n\n}"]}